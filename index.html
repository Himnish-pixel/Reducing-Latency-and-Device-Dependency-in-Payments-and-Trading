<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
  <title>PALMPAY - Payment Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      min-height: 100vh;
      color: #1a1a1a;
      position: relative;
      overflow-x: hidden;
      transition: background 0.3s ease, color 0.3s ease;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    body.light-mode {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #1a1a1a;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(236, 72, 153, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 60% 70%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      animation: backgroundShift 20s ease infinite;
      z-index: -1;
      transition: opacity 0.3s ease;
    }

    body.light-mode::before {
      background: 
        radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
    }


    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 80px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(102, 126, 234, 0.2);
      box-shadow: 2px 0 20px rgba(102, 126, 234, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      gap: 20px;
      z-index: 100;
      transition: all 0.3s ease;
    }

    body.light-mode .sidebar {
      background: rgba(255, 255, 255, 0.98);
      border-right: 1px solid rgba(102, 126, 234, 0.15);
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.05);
    }

    .sidebar-logo {
      font-size: 2em;
      margin-bottom: 20px;
    }

    .nav-item {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(102, 126, 234, 0.08);
      border: 2px solid transparent;
      position: relative;
    }

    body.light-mode .nav-item {
      background: rgba(102, 126, 234, 0.1);
    }

    .nav-item:hover {
      transform: scale(1.1);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    .nav-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .nav-tooltip {
      position: absolute;
      left: 70px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    body.light-mode .nav-tooltip {
      background: rgba(0, 0, 0, 0.8);
    }

    .nav-item:hover .nav-tooltip {
      opacity: 1;
    }

    .theme-toggle {
      margin-top: auto;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.1) rotate(20deg);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    /* Main Content */
    .main-content {
      margin-left: 80px;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      text-align: center;
      padding: 20px;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 3em;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      letter-spacing: -0.02em;
    }

    .header p {
      font-size: 1.2em;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 400;
    }

    body.light-mode .header p {
      color: #4a5568;
    }

    /* Page Sections */
    .page-section {
      display: none;
      max-width: 1400px;
      margin: 0 auto;
    }

    .page-section.active {
      display: block;
    }

    .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 25px;
    }

    .container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      transition: all 0.3s ease;
    }

    body.light-mode .container {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }

    .container:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px 0 rgba(102, 126, 234, 0.4);
    }

    .container h2 {
      font-size: 2em;
      font-weight: 600;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      color: #2d3748;
      letter-spacing: -0.01em;
    }

    body.light-mode .container h2 {
      color: #2d3748;
    }

    .icon {
      font-size: 1.3em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Wallet Styles */
    .wallet-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }

    button {
      padding: 15px 25px;
      font-size: 1em;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    #connectDemoButton, #connectRealButton {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #connectDemoButton:hover, #connectRealButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      opacity: 0.6;
    }

    body.light-mode button:disabled {
      background: #e2e8f0;
      color: #a0aec0;
    }

    #walletInfo {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 25px;
      margin-top: 20px;
    }

    body.light-mode #walletInfo {
      background: rgba(0, 0, 0, 0.05);
    }

    #walletInfo p {
      margin: 15px 0;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #walletInfo strong {
      color: #667eea;
    }

    #walletBalance {
      font-size: 1.5em;
      font-weight: bold;
      color: #4ade80;
      text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
    }

    #walletAddress {
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      color: #667eea;
      word-break: break-all;
      font-weight: 500;
    }

    body.light-mode #walletAddress {
      color: #667eea;
    }

    #refreshButton {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      margin-top: 15px;
    }

    #refreshButton:hover {
      box-shadow: 0 5px 20px rgba(74, 222, 128, 0.5);
    }

    #addDevEthButton {
      background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
      color: white;
      margin-top: 15px;
    }

    #addDevEthButton:hover {
      box-shadow: 0 5px 20px rgba(251, 146, 60, 0.5);
    }

    #faucetLink {
      display: inline-block;
      margin-top: 15px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #faucetLink:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(236, 72, 153, 0.5);
    }

    /* Camera Styles */
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border-radius: 20px;
      padding: 20px;
      overflow: hidden;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    body.light-mode .camera-container {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
      border: 1px solid rgba(102, 126, 234, 0.15);
    }

    #cameraVideo {
      width: 100%;
      border-radius: 16px;
      display: block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
    }

    #cameraCanvas {
      display: none;
    }

    .camera-controls {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .payment-info {
      margin-top: 20px;
      padding: 20px;
      background: rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      text-align: center;
    }

    .payment-status {
      font-size: 1.5em;
      font-weight: bold;
      margin: 10px 0;
      padding: 15px;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .payment-status.waiting {
      color: #667eea;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
      border: 1px solid rgba(102, 126, 234, 0.3);
    }

    .payment-status.detected {
      color: #10b981;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
      border: 1px solid rgba(16, 185, 129, 0.4);
      animation: pulse 1s ease-in-out infinite;
    }

    .payment-status.completed {
      color: #059669;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.25) 0%, rgba(5, 150, 105, 0.25) 100%);
      border: 1px solid rgba(16, 185, 129, 0.5);
    }

    .hand-detection-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      background: rgba(102, 126, 234, 0.95);
      color: white;
      padding: 15px;
      border-radius: 12px;
      font-size: 0.9em;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      backdrop-filter: blur(10px);
    }

    /* Vault Styles */
    .upload-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
    }

    body.light-mode .upload-section {
      background: rgba(0, 0, 0, 0.05);
    }

    input[type="file"] {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      border: 2px dashed rgba(102, 126, 234, 0.4);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8);
      color: #2d3748;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    body.light-mode input[type="file"] {
      background: rgba(255, 255, 255, 0.9);
      color: #2d3748;
      border-color: rgba(102, 126, 234, 0.3);
    }

    input[type="file"]:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    #uploadButton {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px;
      font-size: 1.1em;
    }

    #uploadButton:hover {
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    #status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: bold;
      text-align: center;
      font-size: 1.1em;
    }

    #result {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      word-break: break-all;
      color: #10b981;
      border: 1px solid rgba(74, 222, 128, 0.3);
      font-weight: 500;
    }

    body.light-mode #result {
      background: linear-gradient(135deg, rgba(74, 222, 128, 0.08) 0%, rgba(16, 185, 129, 0.08) 100%);
      color: #059669;
    }

    #filesList {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.06) 0%, rgba(118, 75, 162, 0.06) 100%);
      border-radius: 16px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid rgba(102, 126, 234, 0.15);
    }

    body.light-mode #filesList {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      border: 1px solid rgba(102, 126, 234, 0.12);
    }

    .file-item {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border: 1px solid rgba(102, 126, 234, 0.25);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    body.light-mode .file-item {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .file-item:hover {
      background: rgba(102, 126, 234, 0.3);
      transform: translateX(5px);
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
      word-break: break-word;
    }

    body.light-mode .file-name {
      color: #2d3748;
    }

    .file-cid {
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      color: #667eea;
      word-break: break-all;
      font-weight: 500;
    }

    body.light-mode .file-cid {
      color: #667eea;
    }

    .file-actions {
      display: flex;
      gap: 10px;
    }

    .file-btn {
      padding: 8px 15px;
      font-size: 0.9em;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .view-btn {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
    }

    .delete-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .file-btn:hover {
      transform: scale(1.05);
    }

    .empty-files {
      text-align: center;
      padding: 30px;
      color: #718096;
      font-weight: 500;
    }

    body.light-mode .empty-files {
      color: #718096;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(102, 126, 234, 0.2);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
    }

    body.light-mode .stat-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
      border-color: rgba(102, 126, 234, 0.15);
    }

    .stat-number {
      font-size: 1.8em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      color: #718096;
      font-weight: 500;
    }

    body.light-mode .stat-label {
      color: #718096;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
        padding: 15px 0;
      }

      .nav-item {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }

      .main-content {
        margin-left: 60px;
      }

      .page-grid {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .wallet-buttons {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-logo">üí≥</div>
    
    <div class="nav-item active" data-page="wallet">
      üí∞
      <span class="nav-tooltip">Wallet</span>
    </div>
    
    <div class="nav-item" data-page="camera">
      üì∑
      <span class="nav-tooltip">Gesture Pay</span>
    </div>
    
    <div class="nav-item" data-page="trading">
      üìà
      <span class="nav-tooltip">Trading</span>
    </div>
    
    <div class="nav-item" data-page="vault">
      üîê
      <span class="nav-tooltip">Vault</span>
    </div>
    
    <button class="theme-toggle" id="themeToggle" title="Toggle Dark/Light Mode">üåô</button>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h1>PALMPAY</h1>
      <p>Your ETH Wallet & Secure Payment Platform</p>
    </div>

    <!-- Wallet Page -->
    <div class="page-section active" id="walletPage">
      <div class="page-grid">
        <div class="container" id="walletContainer">
          <h2><span class="icon">üí∞</span> ETH Wallet</h2>
          
          <div class="wallet-buttons">
            <button id="connectDemoButton">üí≥ Demo Wallet</button>
            <button id="connectRealButton">ü¶ä Connect MetaMask</button>
          </div>
          
          <div id="walletInfo" style="display: none;">
            <p><strong>Status:</strong> <span id="walletStatus"></span></p>
            <p><strong>Address:</strong> <span id="walletAddress"></span></p>
            <p><strong>Balance:</strong> <span id="walletBalance"></span> ETH</p>
            
            <div class="wallet-buttons">
              <button id="refreshButton">üîÑ Refresh</button>
              <button id="addDevEthButton">‚ûï Add 100 ETH</button>
            </div>
            
            <a id="faucetLink" href="#" target="_blank">üö∞ Get Test ETH (Faucet)</a>

            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number" id="transactionsCount">0</div>
                <div class="stat-label">Transactions</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="paymentsCount">0</div>
                <div class="stat-label">Payments Made</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalSpent">0 ETH</div>
                <div class="stat-label">Total Spent</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Payment Page -->
    <div class="page-section" id="cameraPage">
      <div class="page-grid">
        <div class="container">
          <h2><span class="icon">üì∑</span> Gesture Payment</h2>
          
          <div class="payment-info">
            <h3 style="margin-bottom: 15px; color: #2d3748; font-weight: 600;">Raise Your Hand to Complete Payment</h3>
            <div class="payment-status waiting" id="paymentStatus">
              Waiting for hand gesture...
            </div>
            <p style="margin-top: 15px; color: #4a5568; font-weight: 500;">
              Amount: <strong id="paymentAmount" style="color: #667eea;">0.01 ETH</strong>
            </p>
            <input type="number" id="paymentAmountInput" value="0.01" step="0.01" min="0.01" 
                   style="width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; 
                          background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(102, 126, 234, 0.3); 
                          color: #2d3748; font-size: 1em; font-weight: 500;" />
          </div>

          <div class="camera-container">
            <div class="hand-detection-overlay" id="handDetectionInfo">
              <strong>Hand Detection:</strong> <span id="handStatus">Initializing...</span>
            </div>
            <video id="cameraVideo" autoplay playsinline></video>
            <canvas id="cameraCanvas"></canvas>
          </div>

          <div class="camera-controls">
            <button id="startCameraButton" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 30px;">
              üì∑ Start Camera
            </button>
            <button id="stopCameraButton" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 15px 30px; display: none;">
              ‚èπÔ∏è Stop Camera
            </button>
          </div>

          <div id="paymentResult" style="display: none; margin-top: 20px; padding: 25px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%); border-radius: 16px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.3);">
            <h3 style="color: #059669; margin-bottom: 10px; font-weight: 600;">‚úÖ Payment Successful!</h3>
            <p id="paymentResultText" style="color: #2d3748; font-weight: 500;"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Trading Page -->
    <div class="page-section" id="tradingPage">
      <div class="page-grid">
        <div class="container" style="grid-column: 1 / -1;">
          <div class="trading-header">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 15px;">
              <span class="icon">üìà</span> Live Trading
            </h2>
            <div class="market-status open">
              <span class="status-dot"></span>
              <span>Market Open</span>
            </div>
          </div>

          <div class="trading-tabs">
            <button class="trading-tab active" data-tab="stocks">Stocks</button>
            <button class="trading-tab" data-tab="crypto">Cryptocurrency</button>
          </div>

          <!-- Stocks Tab -->
          <div class="trading-content active" id="stocksTab">
            <div class="asset-list" id="stocksList">
              <!-- Stocks will be populated by JavaScript -->
            </div>
          </div>

          <!-- Crypto Tab -->
          <div class="trading-content" id="cryptoTab">
            <div class="asset-list" id="cryptoList">
              <!-- Cryptos will be populated by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Trading Panel -->
        <div class="container">
          <h2 style="margin-bottom: 20px;"><span class="icon">üíº</span> Place Order</h2>
          
          <div class="trading-panel">
            <div class="trading-form">
              <div class="form-group">
                <label>Asset</label>
                <select id="selectedAsset">
                  <option value="">Select an asset...</option>
                </select>
              </div>

              <div class="form-group">
                <label>Order Type</label>
                <select id="orderType">
                  <option value="buy">Buy</option>
                  <option value="sell">Sell</option>
                </select>
              </div>

              <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="orderQuantity" value="1" min="0.01" step="0.01" />
              </div>

              <div class="order-summary">
                <div class="order-summary-item">
                  <span>Price per unit:</span>
                  <span id="orderPrice">$0.00</span>
                </div>
                <div class="order-summary-item">
                  <span>Total:</span>
                  <span id="orderTotal">$0.00</span>
                </div>
              </div>

              <div class="palm-payment-section">
                <h3 style="color: #2d3748; margin-bottom: 15px; font-weight: 600;">Show Your Palm to Confirm Payment</h3>
                <div class="palm-status waiting" id="palmPaymentStatus">
                  üëã Show your palm to camera
                </div>
                
                <div class="trading-camera">
                  <video id="tradingCameraVideo" autoplay playsinline style="display: none;"></video>
                  <canvas id="tradingCameraCanvas" style="display: none;"></canvas>
                  <div id="tradingCameraPlaceholder" style="padding: 60px; text-align: center; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); color: #718096; font-weight: 500;">
                    üì∑ Camera will activate when order is ready
                  </div>
                </div>

                <button id="startTradingCameraButton" style="margin-top: 15px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; display: none;">
                  üì∑ Start Camera
                </button>
              </div>

              <div id="tradingPaymentResult" style="display: none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%); border-radius: 16px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.3);">
                <h3 style="color: #059669; margin-bottom: 10px; font-weight: 600;">‚úÖ Order Executed!</h3>
                <p id="tradingPaymentResultText" style="color: #2d3748; font-weight: 500;"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vault Page -->
    <div class="page-section" id="vaultPage">
      <div class="page-grid">
        <div class="container" id="uploaderContainer">
          <h2><span class="icon">üîê</span> Document Vault</h2>
          
          <div class="upload-section">
            <input type="file" id="fileInput" />
            <button id="uploadButton">üì§ Upload to IPFS</button>
          </div>

          <p id="status"></p>
          <code id="result"></code>

          <button id="showFilesButton" style="width: 100%; margin-top: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%); color: white; padding: 15px; font-size: 1.1em;">üìÇ Show All Saved Files</button>

          <div id="filesList" style="display: none; margin-top: 20px;"></div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">0</div>
              <div class="stat-label">Documents</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">0 MB</div>
              <div class="stat-label">Storage Used</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">5 GB</div>
              <div class="stat-label">Available</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const socket = io('http://localhost:3000');

    // --- SIDEBAR NAVIGATION ---
    const navItems = document.querySelectorAll('.nav-item');
    const pageSections = document.querySelectorAll('.page-section');

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const targetPage = item.getAttribute('data-page');
        
        navItems.forEach(nav => nav.classList.remove('active'));
        item.classList.add('active');
        
        pageSections.forEach(page => page.classList.remove('active'));
        document.getElementById(targetPage + 'Page').classList.add('active');
      });
    });

    // --- THEME TOGGLE ---
    const themeToggle = document.getElementById('themeToggle');
    const body = document.body;
    
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'light') {
      body.classList.add('light-mode');
      themeToggle.textContent = '‚òÄÔ∏è';
    }
    
    themeToggle.addEventListener('click', () => {
      body.classList.toggle('light-mode');
      const isLight = body.classList.contains('light-mode');
      themeToggle.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    // --- WALLET ELEMENTS ---
    const connectDemoButton = document.getElementById('connectDemoButton');
    const connectRealButton = document.getElementById('connectRealButton');
    const walletInfoEl = document.getElementById('walletInfo');
    const walletStatusEl = document.getElementById('walletStatus');
    const walletAddressEl = document.getElementById('walletAddress');
    const walletBalanceEl = document.getElementById('walletBalance');
    const faucetLinkEl = document.getElementById('faucetLink');
    
    const refreshButton = document.getElementById('refreshButton');
    const addDevEthButton = document.getElementById('addDevEthButton');

    // --- ETHERS CONFIGURATION ---
    let userSigner = null;
    let currentWalletStatus = "";
    
    let currentRealBalance = 0.0;
    let localBalanceOffset = 0;

    const myPersonalRPC = 'https://eth-mainnet.g.alchemy.com/v2/uSoHU11lywEIj-xTGZnhT';
    const testnetProvider = new ethers.providers.JsonRpcProvider(myPersonalRPC);

    const testnetChainId = '0xaa36a7';
    const faucetUrl = 'https://sepoliafaucet.com/';

    // --- WALLET CONNECTION LOGIC ---

    async function connectRealWallet() {
      localBalanceOffset = 0;
      if (typeof window.ethereum !== 'undefined') {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: testnetChainId }],
            });
          } catch (switchError) {
            if (switchError.code === 4902) {
              alert('Please add Sepolia testnet to your MetaMask. Go to Settings > Networks > Add Network and add Sepolia.');
            } else {
              throw switchError;
            }
          }
          
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          userSigner = provider.getSigner();
          await updateWalletUI(userSigner, "MetaMask Connected");
        } catch (error) {
          console.error('Error connecting to MetaMask:', error);
          alert(`Failed to connect wallet: ${error.message}`);
        }
      } else {
        alert('MetaMask is not detected! Please install MetaMask extension from metamask.io');
      }
    }

    async function connectDemoWallet() {
      localBalanceOffset = 0;
      try {
        let privateKey = localStorage.getItem('demoPrivateKey');
        if (!privateKey) {
          const newWallet = ethers.Wallet.createRandom();
          privateKey = newWallet.privateKey;
          localStorage.setItem('demoPrivateKey', privateKey);
          alert('New demo wallet created! Get test ETH from the faucet.');
        } else {
          alert('Demo wallet loaded from browser.');
        }
        userSigner = new ethers.Wallet(privateKey, testnetProvider);
        await updateWalletUI(userSigner, "Demo Wallet Active");
      } catch (error) {
        console.error('Failed to connect demo wallet:', error);
        alert(`Failed to connect demo wallet: ${error.message}`);
      }
    }

    async function updateWalletUI(signer, statusText) {
      if (!signer) return;
      
      currentWalletStatus = statusText;

      try {
        walletInfoEl.style.display = 'block';
        refreshButton.style.display = 'none';
        addDevEthButton.style.display = 'none';
        walletStatusEl.innerText = `${statusText} (Loading...)`;
        walletStatusEl.style.color = '#667eea';
        walletStatusEl.classList.add('loading');
        walletAddressEl.innerText = '...';
        walletBalanceEl.innerText = '...';

        const address = await signer.getAddress();
        const balance = await signer.getBalance();
        const balanceInEth = ethers.utils.formatEther(balance);

        currentRealBalance = parseFloat(balanceInEth);
        
        if (!statusText.includes("Refreshing...")) {
             localBalanceOffset = 0;
        }
        
        const displayBalance = currentRealBalance + localBalanceOffset;
        
        walletStatusEl.innerText = statusText;
        walletStatusEl.style.color = '#4ade80';
        walletStatusEl.classList.remove('loading');
        walletAddressEl.innerText = address;
        walletBalanceEl.innerText = displayBalance.toFixed(5);
        faucetLinkEl.href = faucetUrl;
        
        refreshButton.style.display = 'inline-block';
        addDevEthButton.style.display = 'inline-block';
        
        // Enable trading if on trading page
        if (currentOrder && document.getElementById('tradingPage').classList.contains('active')) {
          startTradingCameraButton.style.display = 'inline-block';
        }

      } catch (error) {
        console.error('Failed to update wallet UI:', error);
        walletStatusEl.innerText = 'Error loading balance';
        walletStatusEl.style.color = '#ef4444';
        walletStatusEl.classList.remove('loading');
        try {
          const address = await signer.getAddress();
          walletAddressEl.innerText = address;
        } catch (e) {
          walletAddressEl.innerText = "Error loading address";
        }
      }
    }
    
    async function refreshBalance() {
      if (!userSigner) {
        alert('Please connect a wallet first.');
        return;
      }
      localBalanceOffset = 0;
      
      walletStatusEl.innerText = `${currentWalletStatus} (Refreshing...)`;
      walletBalanceEl.innerText = '...';
      
      await updateWalletUI(userSigner, currentWalletStatus);
    }
    
    function addDevEth() {
        localBalanceOffset += 100;
        const displayBalance = currentRealBalance + localBalanceOffset;
        walletBalanceEl.innerText = displayBalance.toFixed(5);
        walletStatusEl.innerText = `${currentWalletStatus} (Simulated)`;
        walletStatusEl.style.color = '#fb923c';
    }

    connectDemoButton.addEventListener('click', connectDemoWallet);
    connectRealButton.addEventListener('click', connectRealWallet);
    refreshButton.addEventListener('click', refreshBalance);
    addDevEthButton.addEventListener('click', addDevEth);

    // --- CAMERA & HAND GESTURE DETECTION ---
    const cameraVideo = document.getElementById('cameraVideo');
    const cameraCanvas = document.getElementById('cameraCanvas');
    const startCameraButton = document.getElementById('startCameraButton');
    const stopCameraButton = document.getElementById('stopCameraButton');
    const paymentStatus = document.getElementById('paymentStatus');
    const handStatus = document.getElementById('handStatus');
    const paymentAmountInput = document.getElementById('paymentAmountInput');
    const paymentAmount = document.getElementById('paymentAmount');
    const paymentResult = document.getElementById('paymentResult');
    const paymentResultText = document.getElementById('paymentResultText');

    let cameraStream = null;
    let hands = null;
    let camera = null;
    let isProcessingPayment = false;
    let handRaisedCount = 0;

    // Simple hand detection using basic pose estimation
    function detectHandRaised(video, canvas) {
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      
      // Simple heuristic: detect if hands are in upper portion of frame
      // This is a simplified detection - in production, use MediaPipe or TensorFlow.js
      const centerY = canvas.height / 2;
      const upperRegion = imageData.data;
      
      // Check for skin tone colors in upper region (simplified)
      let handPixels = 0;
      for (let i = 0; i < upperRegion.length; i += 4) {
        const r = upperRegion[i];
        const g = upperRegion[i + 1];
        const b = upperRegion[i + 2];
        const y = Math.floor((i / 4) / canvas.width);
        
        // Simple skin tone detection (upper region only)
        if (y < centerY && r > 95 && g > 40 && b > 20 && r > g && r > b) {
          handPixels++;
        }
      }
      
      return handPixels > 5000; // Threshold for hand detection
    }

    async function startCamera() {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: 'user'
          } 
        });
        
        cameraVideo.srcObject = cameraStream;
        handStatus.textContent = 'Camera active - Raise your hand!';
        handStatus.style.color = '#4ade80';
        
        startCameraButton.style.display = 'none';
        stopCameraButton.style.display = 'inline-block';
        
        // Start hand detection loop
        detectHandLoop();
        
      } catch (error) {
        console.error('Error accessing camera:', error);
        handStatus.textContent = 'Camera access denied. Please allow camera permissions.';
        handStatus.style.color = '#ef4444';
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      
      cameraVideo.srcObject = null;
      handStatus.textContent = 'Camera stopped';
      handStatus.style.color = '#718096';
      
      startCameraButton.style.display = 'inline-block';
      stopCameraButton.style.display = 'none';
      
      paymentStatus.className = 'payment-status waiting';
      paymentStatus.textContent = 'Waiting for hand gesture...';
    }

    function detectHandLoop() {
      if (!cameraStream || cameraVideo.readyState !== cameraVideo.HAVE_ENOUGH_DATA) {
        requestAnimationFrame(detectHandLoop);
        return;
      }

      const handRaised = detectHandRaised(cameraVideo, cameraCanvas);
      
      if (handRaised) {
        handRaisedCount++;
        handStatus.textContent = `Hand detected! (${handRaisedCount})`;
        handStatus.style.color = '#10b981';
        
        if (handRaisedCount > 10 && !isProcessingPayment) {
          processPayment();
        }
      } else {
        handRaisedCount = 0;
        handStatus.textContent = 'Waiting for hand...';
        handStatus.style.color = '#667eea';
        handStatus.style.fontWeight = '500';
      }
      
      requestAnimationFrame(detectHandLoop);
    }

    async function processPayment() {
      if (isProcessingPayment || !userSigner) {
        return;
      }
      
      isProcessingPayment = true;
      paymentStatus.className = 'payment-status detected';
      paymentStatus.textContent = 'Hand detected! Processing payment...';
      
      const amount = parseFloat(paymentAmountInput.value) || 0.01;
      
      try {
        // Simulate payment processing
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Update balance
        localBalanceOffset -= amount;
        const displayBalance = currentRealBalance + localBalanceOffset;
        walletBalanceEl.innerText = displayBalance.toFixed(5);
        
        // Update stats
        const paymentsCount = parseInt(document.getElementById('paymentsCount').textContent) + 1;
        const totalSpent = parseFloat(document.getElementById('totalSpent').textContent) + amount;
        document.getElementById('paymentsCount').textContent = paymentsCount;
        document.getElementById('totalSpent').textContent = totalSpent.toFixed(3) + ' ETH';
        
        paymentStatus.className = 'payment-status completed';
        paymentStatus.textContent = '‚úÖ Payment completed!';
        
        paymentResult.style.display = 'block';
        paymentResultText.textContent = `Successfully paid ${amount} ETH via gesture payment!`;
        
        // Reset after 3 seconds
        setTimeout(() => {
          isProcessingPayment = false;
          handRaisedCount = 0;
          paymentStatus.className = 'payment-status waiting';
          paymentStatus.textContent = 'Waiting for hand gesture...';
          paymentResult.style.display = 'none';
        }, 3000);
        
      } catch (error) {
        console.error('Payment error:', error);
        paymentStatus.className = 'payment-status waiting';
        paymentStatus.textContent = 'Payment failed. Please try again.';
        isProcessingPayment = false;
        handRaisedCount = 0;
      }
    }

    paymentAmountInput.addEventListener('input', (e) => {
      paymentAmount.textContent = e.target.value + ' ETH';
    });

    startCameraButton.addEventListener('click', startCamera);
    stopCameraButton.addEventListener('click', stopCamera);

    // --- UPLOADER LOGIC ---
    
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const showFilesButton = document.getElementById('showFilesButton');
    const filesListEl = document.getElementById('filesList');

    function getSavedFiles() {
      const files = localStorage.getItem('uploadedFiles');
      return files ? JSON.parse(files) : [];
    }

    function saveFile(fileName, cid) {
      const files = getSavedFiles();
      files.push({ fileName, cid, timestamp: new Date().toISOString() });
      localStorage.setItem('uploadedFiles', JSON.stringify(files));
      updateStats();
    }

    function deleteFile(cid) {
      let files = getSavedFiles();
      files = files.filter(file => file.cid !== cid);
      localStorage.setItem('uploadedFiles', JSON.stringify(files));
      displayFiles();
      updateStats();
    }

    function updateStats() {
      const files = getSavedFiles();
      const docCount = files.length;
      const statCards = document.querySelectorAll('#vaultPage .stat-card .stat-number');
      if (statCards.length > 0) {
        statCards[0].textContent = docCount;
      }
    }

    function displayFiles() {
      const files = getSavedFiles();
      
      if (files.length === 0) {
        filesListEl.innerHTML = '<div class="empty-files">üì≠ No files uploaded yet. Upload your first document!</div>';
      } else {
        filesListEl.innerHTML = files.map(file => `
          <div class="file-item">
            <div class="file-info">
              <div class="file-name">üìÑ ${file.fileName}</div>
              <div class="file-cid">CID: ${file.cid}</div>
            </div>
            <div class="file-actions">
              <button class="file-btn view-btn" onclick="viewFile('${file.cid}')">üëÅÔ∏è View</button>
              <button class="file-btn delete-btn" onclick="deleteFileHandler('${file.cid}')">üóëÔ∏è Delete</button>
            </div>
          </div>
        `).join('');
      }
      
      filesListEl.style.display = 'block';
    }

    showFilesButton.addEventListener('click', () => {
      if (filesListEl.style.display === 'none') {
        displayFiles();
        showFilesButton.textContent = 'üîº Hide Files';
      } else {
        filesListEl.style.display = 'none';
        showFilesButton.textContent = 'üìÇ Show All Saved Files';
      }
    });

    window.viewFile = function(cid) {
      window.open(`https://gateway.pinata.cloud/ipfs/${cid}`, '_blank');
    };

    window.deleteFileHandler = function(cid) {
      if (confirm('Are you sure you want to delete this file from your vault?')) {
        deleteFile(cid);
      }
    };

    uploadButton.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) {
        statusEl.innerText = '‚ùå No file selected!';
        statusEl.style.color = '#ef4444';
        statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
        statusEl.style.border = '1px solid rgba(239, 68, 68, 0.3)';
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file); 

      statusEl.innerText = '‚è≥ Uploading to IPFS...';
      statusEl.style.color = '#667eea';
      statusEl.style.background = 'rgba(102, 126, 234, 0.1)';
      statusEl.style.border = '1px solid rgba(102, 126, 234, 0.3)';
      statusEl.classList.add('loading');
      uploadButton.disabled = true;

      try {
        const response = await fetch('http://localhost:3000/upload', {
          method: 'POST',
          body: formData, 
        });

        const data = await response.json();

        if (response.ok) {
          statusEl.innerText = '‚úÖ Upload Successful!';
          statusEl.style.color = '#4ade80';
          statusEl.style.background = 'rgba(74, 222, 128, 0.1)';
          statusEl.style.border = '1px solid rgba(74, 222, 128, 0.3)';
          statusEl.classList.remove('loading');
          resultEl.innerText = `CID: ${data.cid}`;
          resultEl.style.display = 'block';
          
          saveFile(file.name, data.cid);
          fileInput.value = '';
        } else {
          statusEl.innerText = `‚ùå Error: ${data.error}`;
          statusEl.style.color = '#ef4444';
          statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
          statusEl.style.border = '1px solid rgba(239, 68, 68, 0.3)';
          statusEl.classList.remove('loading');
        }

      } catch (error) {
        console.error('Upload failed:', error);
        statusEl.innerText = '‚ùå Upload failed. Check console.';
        statusEl.style.color = '#ef4444';
        statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
        statusEl.style.border = '1px solid rgba(239, 68, 68, 0.3)';
        statusEl.classList.remove('loading');
      } finally {
        uploadButton.disabled = false;
      }
    });

    updateStats();

    // --- TRADING PAGE LOGIC ---
    const tradingTabs = document.querySelectorAll('.trading-tab');
    const tradingContents = document.querySelectorAll('.trading-content');
    const stocksList = document.getElementById('stocksList');
    const cryptoList = document.getElementById('cryptoList');
    const selectedAssetSelect = document.getElementById('selectedAsset');
    const orderTypeSelect = document.getElementById('orderType');
    const orderQuantityInput = document.getElementById('orderQuantity');
    const orderPriceEl = document.getElementById('orderPrice');
    const orderTotalEl = document.getElementById('orderTotal');
    const palmPaymentStatus = document.getElementById('palmPaymentStatus');
    const tradingCameraVideo = document.getElementById('tradingCameraVideo');
    const tradingCameraCanvas = document.getElementById('tradingCameraCanvas');
    const tradingCameraPlaceholder = document.getElementById('tradingCameraPlaceholder');
    const startTradingCameraButton = document.getElementById('startTradingCameraButton');
    const tradingPaymentResult = document.getElementById('tradingPaymentResult');
    const tradingPaymentResultText = document.getElementById('tradingPaymentResultText');

    // Realistic stock and crypto data with original prices for reference
    const stocksBaseData = [
      { symbol: 'AAPL', name: 'Apple Inc.', icon: 'üçé', originalPrice: 175.50 },
      { symbol: 'GOOGL', name: 'Alphabet Inc.', icon: 'üîç', originalPrice: 142.30 },
      { symbol: 'MSFT', name: 'Microsoft Corp.', icon: 'ü™ü', originalPrice: 378.85 },
      { symbol: 'TSLA', name: 'Tesla Inc.', icon: '‚ö°', originalPrice: 248.50 },
      { symbol: 'AMZN', name: 'Amazon.com Inc.', icon: 'üì¶', originalPrice: 151.20 },
      { symbol: 'META', name: 'Meta Platforms', icon: 'üë§', originalPrice: 485.30 },
      { symbol: 'NVDA', name: 'NVIDIA Corp.', icon: 'üéÆ', originalPrice: 875.40 },
      { symbol: 'JPM', name: 'JPMorgan Chase', icon: 'üè¶', originalPrice: 195.60 }
    ];

    const cryptoBaseData = [
      { symbol: 'BTC', name: 'Bitcoin', icon: '‚Çø', originalPrice: 43250.50 },
      { symbol: 'ETH', name: 'Ethereum', icon: 'Œû', originalPrice: 2650.75 },
      { symbol: 'BNB', name: 'Binance Coin', icon: 'üü°', originalPrice: 315.40 },
      { symbol: 'SOL', name: 'Solana', icon: '‚óé', originalPrice: 98.25 },
      { symbol: 'ADA', name: 'Cardano', icon: '‚Ç≥', originalPrice: 0.52 },
      { symbol: 'XRP', name: 'Ripple', icon: 'üíß', originalPrice: 0.62 },
      { symbol: 'DOGE', name: 'Dogecoin', icon: 'üêï', originalPrice: 0.085 },
      { symbol: 'DOT', name: 'Polkadot', icon: '‚ö´', originalPrice: 7.15 }
    ];

    // Initialize with starting prices and changes
    const stocksData = stocksBaseData.map(stock => ({
      ...stock,
      basePrice: stock.originalPrice,
      change: (Math.random() - 0.5) * 5
    }));

    const cryptoData = cryptoBaseData.map(crypto => ({
      ...crypto,
      basePrice: crypto.originalPrice,
      change: (Math.random() - 0.5) * (crypto.originalPrice * 0.05)
    }));

    let assetsData = { stocks: [...stocksData], crypto: [...cryptoData] };
    let tradingCameraStream = null;
    let isTradingPaymentProcessing = false;
    let palmDetectedCount = 0;
    let currentOrder = null;

    // Tab switching
    tradingTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.getAttribute('data-tab');
        
        tradingTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        tradingContents.forEach(content => content.classList.remove('active'));
        document.getElementById(targetTab + 'Tab').classList.add('active');
      });
    });

    // Render asset list
    function renderAssets(type) {
      const container = type === 'stocks' ? stocksList : cryptoList;
      const assets = assetsData[type];
      const baseData = type === 'stocks' ? stocksBaseData : cryptoBaseData;
      
      container.innerHTML = assets.map(asset => {
        const originalAsset = baseData.find(a => a.symbol === asset.symbol);
        const changePercent = originalAsset ? ((asset.change / originalAsset.originalPrice) * 100).toFixed(2) : '0.00';
        const isPositive = asset.change >= 0;
        const volume = (Math.random() * 50 + 10).toFixed(1) + (type === 'crypto' ? 'M' : 'M');
        
        // Format price display
        const priceFormat = type === 'crypto' && asset.basePrice < 1 
          ? asset.basePrice.toFixed(4) 
          : asset.basePrice.toFixed(2);
        
        // Format change display
        const changeFormat = type === 'crypto' && Math.abs(asset.change) < 1 
          ? asset.change.toFixed(4) 
          : asset.change.toFixed(2);
        
        return `
          <div class="asset-item" data-symbol="${asset.symbol}" data-type="${type}">
            <div class="asset-icon">${asset.icon}</div>
            <div class="asset-info">
              <div class="asset-name">${asset.name}</div>
              <div class="asset-symbol">${asset.symbol}</div>
            </div>
            <div class="asset-price" id="price-${asset.symbol}">$${priceFormat}</div>
            <div class="asset-change ${isPositive ? 'positive' : 'negative'}" id="change-${asset.symbol}">
              ${isPositive ? '+' : ''}${changeFormat} (${isPositive ? '+' : ''}${changePercent}%)
            </div>
            <div class="asset-volume">Vol: ${volume}</div>
          </div>
        `;
      }).join('');
      
      // Add click handlers
      container.querySelectorAll('.asset-item').forEach(item => {
        item.addEventListener('click', () => {
          const symbol = item.getAttribute('data-symbol');
          const type = item.getAttribute('data-type');
          selectAsset(symbol, type);
        });
      });
    }

    // Select asset
    function selectAsset(symbol, type) {
      const assets = type === 'stocks' ? stocksData : cryptoData;
      const asset = assets.find(a => a.symbol === symbol);
      
      if (asset) {
        selectedAssetSelect.value = `${type}-${symbol}`;
        updateOrderSummary();
        
        // Highlight selected
        document.querySelectorAll('.asset-item').forEach(item => {
          item.style.border = '1px solid rgba(102, 126, 234, 0.2)';
        });
        document.querySelector(`[data-symbol="${symbol}"]`).style.border = '2px solid #667eea';
      }
    }

    // Update order summary
    function updateOrderSummary() {
      const selected = selectedAssetSelect.value;
      if (!selected) {
        orderPriceEl.textContent = '$0.00';
        orderTotalEl.textContent = '$0.00';
        currentOrder = null;
        return;
      }
      
      const [type, symbol] = selected.split('-');
      const assets = type === 'stocks' ? stocksData : cryptoData;
      const asset = assets.find(a => a.symbol === symbol);
      
      if (asset) {
        const quantity = parseFloat(orderQuantityInput.value) || 0;
        const price = asset.basePrice;
        const total = price * quantity;
        
        orderPriceEl.textContent = `$${price.toFixed(2)}`;
        orderTotalEl.textContent = `$${total.toFixed(2)}`;
        
        currentOrder = { 
          asset, 
          quantity, 
          price, 
          total, 
          type,
          orderType: orderTypeSelect.value 
        };
        
        // Show camera button if wallet connected and order is valid
        if (userSigner && quantity > 0) {
          startTradingCameraButton.style.display = 'inline-block';
        } else {
          startTradingCameraButton.style.display = 'none';
        }
      }
    }

    // Simulate real-time price updates
    function updatePrices() {
      ['stocks', 'crypto'].forEach(type => {
        assetsData[type].forEach(asset => {
          // Simulate realistic price movement (smaller increments for realism)
          const volatility = type === 'crypto' ? 0.02 : 0.01;
          const change = (Math.random() - 0.5) * asset.basePrice * volatility;
          asset.basePrice += change;
          
          // Update change percentage based on original price
          const baseDataForChange = type === 'stocks' ? stocksBaseData : cryptoBaseData;
          const originalAssetForChange = baseDataForChange.find(a => a.symbol === asset.symbol);
          if (originalAssetForChange) {
            asset.change = asset.basePrice - originalAssetForChange.originalPrice;
          }
          
          // Keep prices realistic (prevent extreme values)
          if (type === 'crypto') {
            if (asset.symbol === 'BTC') {
              asset.basePrice = Math.max(35000, Math.min(50000, asset.basePrice));
            } else if (asset.symbol === 'ETH') {
              asset.basePrice = Math.max(2000, Math.min(3000, asset.basePrice));
            } else if (asset.symbol === 'SOL') {
              asset.basePrice = Math.max(80, Math.min(120, asset.basePrice));
            }
          } else {
            // Keep stock prices within reasonable range (¬±30% of original)
            const baseDataForRange = type === 'stocks' ? stocksBaseData : cryptoBaseData;
            const originalAssetForRange = baseDataForRange.find(a => a.symbol === asset.symbol);
            if (originalAssetForRange) {
              asset.basePrice = Math.max(originalAssetForRange.originalPrice * 0.7, Math.min(originalAssetForRange.originalPrice * 1.3, asset.basePrice));
            }
          }
          
          const priceEl = document.getElementById(`price-${asset.symbol}`);
          const changeEl = document.getElementById(`change-${asset.symbol}`);
          
          if (priceEl) {
            const oldPrice = parseFloat(priceEl.textContent.replace('$', '').replace(',', ''));
            const newPrice = asset.basePrice;
            
            // Format price based on type
            const priceFormat = type === 'crypto' && asset.basePrice < 1 
              ? newPrice.toFixed(4) 
              : newPrice.toFixed(2);
            
            priceEl.textContent = `$${priceFormat}`;
            
            // Flash animation
            if (Math.abs(newPrice - oldPrice) > 0.01) {
              priceEl.classList.add(newPrice > oldPrice ? 'price-update' : 'price-update negative');
              setTimeout(() => {
                priceEl.classList.remove('price-update', 'price-update negative');
              }, 500);
            }
            
            const baseDataForPercent = type === 'stocks' ? stocksBaseData : cryptoBaseData;
            const originalAssetForPercent = baseDataForPercent.find(a => a.symbol === asset.symbol);
            const changePercent = originalAssetForPercent ? ((asset.change / originalAssetForPercent.originalPrice) * 100).toFixed(2) : '0.00';
            const isPositive = asset.change >= 0;
            
            if (changeEl) {
              changeEl.className = `asset-change ${isPositive ? 'positive' : 'negative'}`;
              const changeFormat = type === 'crypto' && Math.abs(asset.change) < 1 
                ? asset.change.toFixed(4) 
                : asset.change.toFixed(2);
              changeEl.textContent = `${isPositive ? '+' : ''}${changeFormat} (${isPositive ? '+' : ''}${changePercent}%)`;
            }
          }
        });
      });
      
      // Update order summary if order is active
      if (currentOrder && selectedAssetSelect.value) {
        updateOrderSummary();
      }
    }

    // Palm detection for trading
    function detectPalmForTrading(video, canvas) {
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      
      // Detect palm (open hand) - simplified detection
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const centerRegion = imageData.data;
      
      let palmPixels = 0;
      for (let i = 0; i < centerRegion.length; i += 4) {
        const r = centerRegion[i];
        const g = centerRegion[i + 1];
        const b = centerRegion[i + 2];
        const x = (i / 4) % canvas.width;
        const y = Math.floor((i / 4) / canvas.width);
        
        // Check center region for skin tone (palm detection)
        const distFromCenter = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
        if (distFromCenter < 150 && r > 95 && g > 40 && b > 20 && r > g && r > b) {
          palmPixels++;
        }
      }
      
      return palmPixels > 3000;
    }

    async function startTradingCamera() {
      try {
        tradingCameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          } 
        });
        
        tradingCameraVideo.srcObject = tradingCameraStream;
        tradingCameraVideo.style.display = 'block';
        tradingCameraPlaceholder.style.display = 'none';
        startTradingCameraButton.style.display = 'none';
        
        palmPaymentStatus.className = 'palm-status waiting';
        palmPaymentStatus.textContent = 'üëã Show your palm to confirm payment';
        
        detectPalmLoop();
        
      } catch (error) {
        console.error('Error accessing camera:', error);
        palmPaymentStatus.textContent = 'Camera access denied. Please allow camera permissions.';
        palmPaymentStatus.style.color = '#ef4444';
      }
    }

    function detectPalmLoop() {
      if (!tradingCameraStream || tradingCameraVideo.readyState !== tradingCameraVideo.HAVE_ENOUGH_DATA) {
        requestAnimationFrame(detectPalmLoop);
        return;
      }

      const palmDetected = detectPalmForTrading(tradingCameraVideo, tradingCameraCanvas);
      
      if (palmDetected && currentOrder && !isTradingPaymentProcessing) {
        palmDetectedCount++;
        palmPaymentStatus.className = 'palm-status detected';
        palmPaymentStatus.textContent = `üëã Palm detected! (${palmDetectedCount}/5)`;
        
        if (palmDetectedCount >= 5) {
          executeTradingOrder();
        }
      } else {
        if (palmDetectedCount > 0 && !palmDetected) {
          palmDetectedCount = 0;
          palmPaymentStatus.className = 'palm-status waiting';
          palmPaymentStatus.textContent = 'üëã Show your palm to confirm payment';
        }
      }
      
      requestAnimationFrame(detectPalmLoop);
    }

    async function executeTradingOrder() {
      if (isTradingPaymentProcessing || !currentOrder || !userSigner) {
        return;
      }
      
      isTradingPaymentProcessing = true;
      palmPaymentStatus.className = 'palm-status detected';
      palmPaymentStatus.textContent = '‚úÖ Processing order...';
      
      try {
        // Simulate order processing
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Convert to ETH equivalent (simplified)
        const ethAmount = currentOrder.total / 3000; // Rough ETH conversion
        
        // Update balance
        localBalanceOffset -= ethAmount;
        const displayBalance = currentRealBalance + localBalanceOffset;
        if (walletBalanceEl) {
          walletBalanceEl.innerText = displayBalance.toFixed(5);
        }
        
        // Update stats
        const transactionsCount = parseInt(document.getElementById('transactionsCount').textContent) + 1;
        document.getElementById('transactionsCount').textContent = transactionsCount;
        
        tradingPaymentResult.style.display = 'block';
        const orderTypeText = currentOrder.orderType === 'buy' ? 'Bought' : 'Sold';
        tradingPaymentResultText.textContent = 
          `${orderTypeText} ${currentOrder.quantity} ${currentOrder.asset.symbol} @ $${currentOrder.price.toFixed(2)} = $${currentOrder.total.toFixed(2)}`;
        
        palmPaymentStatus.className = 'palm-status waiting';
        palmPaymentStatus.textContent = '‚úÖ Order completed!';
        
        // Reset after 3 seconds
        setTimeout(() => {
          isTradingPaymentProcessing = false;
          palmDetectedCount = 0;
          currentOrder = null;
          tradingPaymentResult.style.display = 'none';
          palmPaymentStatus.textContent = 'üëã Show your palm to confirm payment';
          
          if (tradingCameraStream) {
            tradingCameraStream.getTracks().forEach(track => track.stop());
            tradingCameraStream = null;
            tradingCameraVideo.style.display = 'none';
            tradingCameraPlaceholder.style.display = 'block';
            startTradingCameraButton.style.display = 'inline-block';
          }
        }, 3000);
        
      } catch (error) {
        console.error('Order execution error:', error);
        palmPaymentStatus.textContent = 'Order failed. Please try again.';
        isTradingPaymentProcessing = false;
        palmDetectedCount = 0;
      }
    }

    // Event listeners
    selectedAssetSelect.addEventListener('change', updateOrderSummary);
    orderQuantityInput.addEventListener('input', updateOrderSummary);
    orderTypeSelect.addEventListener('change', () => {
      if (currentOrder) {
        currentOrder.orderType = orderTypeSelect.value;
      }
    });
    startTradingCameraButton.addEventListener('click', startTradingCamera);

    // Initialize trading page
    renderAssets('stocks');
    renderAssets('crypto');
    
    // Populate asset select
    function populateAssetSelect() {
      selectedAssetSelect.innerHTML = '<option value="">Select an asset...</option>';
      
      stocksData.forEach(asset => {
        const option = document.createElement('option');
        option.value = `stocks-${asset.symbol}`;
        option.textContent = `${asset.symbol} - ${asset.name}`;
        selectedAssetSelect.appendChild(option);
      });
      
      cryptoData.forEach(asset => {
        const option = document.createElement('option');
        option.value = `crypto-${asset.symbol}`;
        option.textContent = `${asset.symbol} - ${asset.name}`;
        selectedAssetSelect.appendChild(option);
      });
    }
    
    populateAssetSelect();
    
    // Start price updates
    setInterval(updatePrices, 2000); // Update every 2 seconds for realistic feel
    
    // Initial price update
    setTimeout(updatePrices, 1000);
  </script>

</body>
</html>
